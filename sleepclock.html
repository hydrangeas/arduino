<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HydTech | Sleep Clock</title>

    <link class="color" rel="stylesheet" href="css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/nivo-slider.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/jquery.fancybox-1.3.4.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css3-github-buttons/gh-buttons.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/github.css" type="text/css" media="screen" />

    <script src="js/jquery-1.5.2.min.js" type="text/javascript"></script> 
    <script src="js/ajax.js" type="text/javascript"></script>
    <script src="js/jquery.easing.1.3.js" type="text/javascript"></script>
    <script src="js/jquery.nivo.slider.pack.js" type="text/javascript"></script>
    <script src="js/jquery.fancybox-1.3.4.pack.js" type="text/javascript"></script>
    <script src="js/jquery.tools.min.js" type="text/javascript"></script>


    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="css/style_ie.css" />
    <![endif]--> 

    <!--[if IE 7]>
    <link rel="stylesheet" type="text/css" href="css/style_ie7.css" />
    <![endif]-->

    <!--Syntax Highlighter-->
    <link href="sh/styles/shCore.css" rel="stylesheet" type="text/css" />
    <link href="sh/styles/shThemeMidnight.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="sh/scripts/shCore.js"></script>
    <script type="text/javascript" src="sh/scripts/shAutoloader.js"></script>
    <script type="text/javascript" src="sh/scripts/shBrushCpp.js"></script>

    <script src="js/main.js" type="text/javascript"></script>


  </head>

  <body>

    <div id="container">

      <div id="menu">

        <h1 id="logo">Jumper</h1>

        <ul>
          <li><a href="index.html" class="panel">Back to Home</a></li>  
          <li><a class="selected" href="sleepclock.html">+ Sleep Clock</a></li>                
        </ul>

      </div> <!--/menu-->

      <div id="wrapper">

        <div class="content">

          <h1 class="title_center">Sleep Clock</h1>
          <div class="separator"></div>
          <div class="one">
          <p>
          ちょっと前から、振動を検知して睡眠サイクルを推定し、最適なタイミングで起こしてくれるアプリを色々と試してます。
          すっきり起きれたりすると嬉しいので、そんな目覚まし時計を探してみたら、意外と高い！
          とりあえず、睡眠サイクルをグラフで取得するような機械を自分で作れないかと試行錯誤したら、
          意外と作れてしまったので、画像を中心に公開してみました。
          </p>

          <p>Agenda</p>
            <ol>
              <li><p>SDカードモジュールの製作 .. 後述しますが、専用のモジュールがなかったので作りました</p></li>
              <li><p>プログラム .. センサデータを取得してSDカードに保存するプログラムを書きました</p></li>
              <li><p>解析 .. 出力されたデータを自動的にグラフにするところまでbash scriptを書きました</p></li>
              <li><p>パッケージング .. なんかちょっと見た目をかっこ良く（可愛く？）してみました</p></li>
            </ol>

          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Circuit Design</h3>
          <div class="separator"></div>
          <div class="one_third">
            <h3>SDカード用回路</h3>
            <p>
            SeeedStudioにはSDカード用のモジュールもあるが、これはArduino/Arduino Uno用。
            Arduino MegaはSPIのポートが異なっているために使えない。
            そこで、Arduino Mega用Prototype ShieldにSDカードスロットを接続した。
            SDカードスロットは<a href="http://www.sunhayato.co.jp/products/details.php?u=1502&id=07013" alt="Sunhayato CK-40" target="_blank">Sunhayato CK-40</a>。右の回路図では31〜34ピンと接続しているが、実際には<strong>50〜53</strong>なので注意（回路図作成ツールのEagleの使い方がよくわからず、番号を書き換えることができなかった）。
            </p>
          </div>
          <div class="two_third"> 
            <a class="image" href="images/photos/projects/sd/sd.png" rel="image"><img src="images/photos/projects/sd/sd.png" alt="image" style="width: 500px;"/></a>
            <p>（クリックして拡大）</p>
          </div>

          <div class="clear"></div>  

          <ul class="gallery_group">
            <li>
            <a class="image" href="images/photos/projects/sd/breadboard.jpg" rel="image"><img src="images/photos/projects/sd/breadboard-thumb.jpg" alt="image"/></a>
            <h5>Breadboard</h5>
            </li>

            <li>
            <a class="image" href="images/photos/projects/sd/sd-circuit-1.jpg" rel="image"><img src="images/photos/projects/sd/sd-circuit-1-thumb.jpg" alt="image"/></a>
            <h5>Circuit (front)</h5>
            </li>

            <li>
            <a class="image" href="images/photos/projects/sd/sd-circuit-2.jpg" rel="image"><img src="images/photos/projects/sd/sd-circuit-2-thumb.jpg" alt="image"/></a>
            <h5>Circuit (back)</h5>
            </li> 

            <li>
            <a class="image" href="images/photos/projects/sd/join.jpg" rel="image"><img src="images/photos/projects/sd/join-thumb.jpg" alt="image"/></a>
            <h5>Join with Arduino Mega</h5>
            </li>

            <li>
            <a class="image" href="images/photos/projects/sd/seeedstudio-sd-1.jpg" rel="image"><img src="images/photos/projects/sd/seeedstudio-sd-1-thumb.jpg" alt="image"/></a>
            <h5>SD Card Shield</h5>
            </li>

            <li>
            <img src="images/photos/projects/sd/seeedstudio-sd-2.jpg" alt="image" />
            <h5>SD Card Shield</h5>
            </li>
          </ul> <!--/gallery_group (1st)--> 

          <div class="clear"></div>  

          <h4 class="title_center">Grove System</h4>
          <div class="separator"></div>
          <div class="two_third">
            <p>
            SeeedStudio社のGroveで各パーツを接続することにより、（基本的には）ハンダ付けなしに各機能を利用できます。
            今回は（SD以外の）すべてのパーツが見つかったので、これを大活用させてもらうことにしました。
            </p>
            <p>
            <a href="http://www.switch-science.com" target="_blank" alt="Switch Science">スイッチサイエンス</a>さんで購入していますが、
            本家本元の<a href="http://www.seeedstudio.com" target="_blank" alt="SeeedStudio">SeeedStudio</a>さんには、
            スイッチサイエンスで扱っていない「手首での脈拍を検知するセンサ」などがあって楽しいです。
            </p>
            <p>今回使ったパーツは以下の通り</p>
            <ul class="check_list">
              <li>7 Segment LED</li>
              <li>Motion Sensor</li>
              <li>Real Time Clock</li>
              <li>RGB LED</li> 
            </ul>

          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/grove_logo.jpg" alt="image" style="width: 200px; height: 200px;" />
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/grove-7seg-thumb.jpg" alt="image" />
            <h5>7 Segment LED</h5>
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/grove-motion-thumb.jpg" alt="image" />
            <h5>Motion Sensor</h5>
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/grove-rtc-thumb.jpg" alt="image" />
            <h5>Real Time Clock</h5>
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/grove-led-thumb.jpg" alt="image" />
            <h5>RGB LED</h5>
          </div>

          <div class="one_third">
            <a class="image" href="images/photos/projects/sd/grove.jpg" alt="grove" rel="image"><img class="frame" src="images/photos/projects/sd/grove-thumb.jpg" alt="image" /></a>
            <h5>Join with Grove</h5>
          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Code</h3>
          <div class="separator"></div>

          <div class="one">
            <h5>SleepClock.c</h5>
            <p>
            時間の取得、動感知センサデータの取得、ログ書き込み、エラー処理の各機能を実装。
            それぞれタイマを用いて擬似的な割り込みを実現しています。
            </p>
          </div>

          <div class="clear"></div>  

          <div class="two_third">
            <pre class="brush:c; highlight:[4,5,6,7]">
#include "Metro.h"
#include "sc.h"

Metro watch4DisplayTimeNumber = Metro(250, 1);
Metro watch4DisplayTimeColon  = Metro(500, 1);
Metro watch4MotionSensor = Metro(200, 1);
Metro watch4WriteData2SD = Metro(10000, 1); //10sec.

void setup() {
  Serial.begin(57600);

  ledSetup();
  dateSetup();
  sdSetup();

  /*
   * Setup Motion Sensor
   */
  pinMode(4, INPUT);

  delay(2000);
}

void loop() {
  // Display time of now, to 7 segment, without colon
  if (watch4DisplayTimeNumber.check() == 1) {
    getDateDs1307();
  }
  // Display time of now, to 7 segment, with colon
  if (watch4DisplayTimeColon.check() == 1) {
    output2seg();
  }
  // Detect motion sensor value
  if (watch4MotionSensor.check() == 1) {
    int sensorValue = digitalRead(4);
    illuminateLed(sensorValue);
    buildLog(sensorValue);
  }
  // Save to SD
  if (watch4WriteData2SD.check() == 1) {
    Log2SD();
  }
}
            </pre>
          </div>
          <div class="one_third">
            <p>複数タイマを実現するArduino Metroライブラリを用いて、割り込みっぽく、各機能を実現しています。</p>
            <p>
            <code>watch4DisplayTimeNumber</code>は現在の時間を7セグメントLEDに表示するためのタイマで、更新間隔は250ms。
            </p>
            <p>
            <code>Metro watch4DisplayTimeColon</code>は7セグメントLEDを更新しますが、RTCモジュールから時間を確認することはありません。
            500ms間隔で更新するのは『時』と『分』の間に表示する『：』（コロン）。
            表示されていれば非表示に、非表示であれば表示します。
            </p>
            <p>
            <code>Metro watch4MotionSensor</code>は動感知センサを確認するセンサで、200ms毎にデータを取得します。
            但し、センサ側の最低更新時間が300msのため、更新間隔については見直す必要があるかもしれません。
            </p>
            <p>
            <code>Metro watch4WriteData2SDor</code>はSDカードへの書き込み間隔で、10,000ms（10s）毎に設定しています。
            これはSDカードへのアクセス頻度を下げることで、SDカード自体の劣化及び、書き込みエラーを防止する目的があります。
            それでも10時間で216,000回にもなるため、更に頻度を下げることが必要かもしれません。
            </p>
          </div>

          <div class="clear"></div>  

          <div class="one_half">
            <h5>SleepClockData.sh</h5>
            <p>
            エラーは生じていないが、壊れたデータを判別して排除する。
            本来はデータ保存時にチェックサムを計算して付与することが望ましいが、今回はそのコストに見合わないと判断し、
            シェルで計算させることにした。
            結果はCSVファイルで出力される。
            </p>
          </div>
          <div class="one_half">
            <h5>SleepClockPlot.sh</h5>
            <p>
            CSVファイルを読み込み、Gnuplotを用いてデータをプロットする。
            デフォルトで読み込んだファイルに『.png』をつけて画像を保存するよう設定した。
            </p>
          </div>

          <div class="clear"></div>  

          <div class="one">
            <div style="width: 100%">
              <div style="margin: 0 auto; width: 25%;">
                <a href="https://github.com/hydrangeas/arduino" class="button pill big primary octocat custom">Source Code</a>
              </div>
            </div>
          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Graph</h3>
          <div class="separator"></div>
          <div class="one">
            <p>
            実際にデータを取得してみました。
            センサの配置位置はベッド（頭位）の高さと同じくらいで、距離は50cm程度離しています。
            それぞれ測位時間が違うのと、継続的なデータがないので、正確なことは言えませんが、なかなかよく測定できているようです。
            </p>
            <p>
            グラフはX軸に時間、Y軸に動感知センサの反応回数をプロットしています。
            すなわち、グラフの数値が高くなっていれば、頻繁に動いた（寝返りなど）ということになります。
            </p>
            <p>
            左側の青いグラフはiPhoneアプリ「快眠サイクル」でのデータです。
            このアプリは枕元にiPhoneを置いて、その振動からサイクルを検知していると思われるので、原理的には同じです。
            </p>
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <h5>2013.01.29 02:30-08:00</h5>
            <a class="image" href="images/photos/projects/sd/SleepData_20130128-1.png" alt="grove" rel="image"><img src="images/photos/projects/sd/SleepData_20130128-1.png" alt="image" style="width: 220px;" /></a>
            <p>
            医学的な見地からは分かりませんが、両方のグラフでは約150分後の午前５時頃、午前５時半頃にデータが大きく変化しており、
            矛盾はありません。
            </p>
          </div>
          <div class="two_third">
            <a class="image" href="images/photos/projects/sd/20130129024612_log.png" alt="grove" rel="image"><img src="images/photos/projects/sd/20130129024612_log.png" alt="image" style="width: 460px;" /></a>
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <h5>2013.01.30 01:00-08:30</h5>
            <a class="image" href="images/photos/projects/sd/SleepData_20130129-1.png" alt="grove" rel="image"><img src="images/photos/projects/sd/SleepData_20130129-1.png" alt="image" style="width: 220px;" /></a>
            <p>
            こちらのデータは少し厄介です。
            午前３時半頃、午前４時半頃のデータは一致しますが、午前２時半頃のデータは一致しません。
            また、快眠サイクルでは午前６時半を起床時間に設定しており、ほぼ同時刻に起床と判断されてしまっているため、それ以後のデータは取得できていませんでした。
            就寝と起床をどのように判断するのかは、少し考える必要がありそうです。
            </p>
          </div>
          <div class="two_third">
            <a class="image" href="images/photos/projects/sd/20130130010455_log.png" alt="grove" rel="image"><img src="images/photos/projects/sd/20130130010455_log.png" alt="image" style="width: 460px;" /></a>
          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Packaging</h3>
          <div class="separator"></div>
          <div class="one">
            <p>
            ちょっとテンションを上げるために、PC直結のパーツむき出しだけじゃなくて、なんか製品っぽくパッケージングしてみました。
            100均で買ってきた箱に入れてみましたが、意外と良い感じに仕上がりました。
            </p>
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-1.jpg" alt="image" />
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-2.jpg" alt="image" />
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-3.jpg" alt="image" />
          </div>

          <div class="clear"></div>  

          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-4.jpg" alt="image" />
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-5.jpg" alt="image" />
          </div>
          <div class="one_third">
            <img class="frame" src="images/photos/projects/sd/SleepClock-6.jpg" alt="image" />
          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Conclusion</h3>
          <div class="separator"></div>
          <div class="one">
            <p>
            ちゃんとしたデータの取得方法とかは分からないのだが、きちんとしたデータを取ることができた。
            きれいにパッケージングもできたので満足！
            </p>
          </div>

          <div class="clear"></div>  

          <h3 class="title_center">Future</h3>
          <div class="separator"></div>
          <div class="one">
            <p>更なる改良のために。</p>
            <ol>
              <li><p>SDカードモジュールのハンダがちょっといけてない（特に裏！）ので、もうちょっと洗練させたい</p></li>
              <li><p>箱が大きいので、もっと小さいパッケージを作りたい</p></li>
              <li><p>XBeeを使って無線通信でデータを送信したい</p></li>
              <li><p>インターネットを通じて直接データを送信したい（サーバ側の開発も含めて）</p></li>
              <li><p>Arduino Pro Miniを使って、可能な限り小さいものにしたい</p></li>
            </ol>
          </div>

          <!--HEADINGS ENDS HERE--> 


        </div> <!--/content-->
        <div class="item"></div>
      </div> <!--/wrapper-->  
    </div> <!--/container-->      

  </body>
</html>
